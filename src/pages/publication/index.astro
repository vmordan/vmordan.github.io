---
import PageLayout from "../../layouts/PageLayout.astro";
import { getCollection } from "astro:content";
import { FULL_NAME } from '../../config/profile';

const pubsRaw = await getCollection("publication");

// Sort: order asc (if present), then title
const pubs = pubsRaw
  .filter(p => !p.data.hide)
  .slice()
  .sort((a, b) => {
    const ao = a.data.order ?? 1_000_000;
    const bo = b.data.order ?? 1_000_000;
    if (ao !== bo) return bo - ao;
    return a.data.title.localeCompare(b.data.title);
  });

const normalizeLink = (link: string) =>
  link.startsWith("10.") ? `https://doi.org/${link}` : link;
---

<PageLayout
  title=`Publications - ${FULL_NAME}`
  description="Selected publications and related materials (PDFs, links, videos)."
>
  <section class="panel">
    <div class="row">
      <h1 class="panel__title">Publications</h1>
      <span class="row__hint">{pubs.length} items</span>
    </div>

    <div class="pub-grid">
      {pubs.map((p) => {
        const link = p.data.link ? normalizeLink(p.data.link) : "";
        const hasPdf = Boolean(p.data.src);
        const hasVideo = Boolean(p.data.videoId);

        return (
          <article class="pub-card">
            <div class="pub-card__top">
              <div class="pub-card__titlewrap">
                <a class="pub-card__title" href={`/publication/${p.id}`}>
                  {p.data.title}
                </a>

                <div class="pub-card__badges">
                  {hasVideo && <span class="tag tag--soft">Video</span>}
                </div>
              </div>

              <p class="pub-card__tagline">{p.data.tagline}</p>
            </div>

            <div class="pub-card__actions">
              <a class="btn btn--ghost" href={`/publication/${p.id}`}>Details</a>

              {link && (
                <a class="btn btn--ghost" href={link} target="_blank" rel="noreferrer">
                  {link.includes("doi.org") || p.data.link.startsWith("10.") ? "DOI" : "Link"}
                </a>
              )}

              {hasPdf && (
                <a class="btn btn--ghost" href={p.data.src} target="_blank" rel="noreferrer">
                  PDF
                </a>
              )}
              {p.data.artifactLink && (
                <a class="btn btn--ghost" href={p.data.artifactLink} target="_blank" rel="noreferrer">
                  Artifact
                </a>
              )}
            </div>
          </article>
        );
      })}
    </div>
  </section>

  <style>
    .row__hint {
      font-size: 12px;
      color: #64748b;
    }

    .pub-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 640px) {
      .pub-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .pub-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 12px;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    .pub-card:hover {
      transform: translateY(-1px);
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .pub-card__titlewrap {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .pub-card__title {
      text-decoration: none;
      color: var(--fg);
      font-weight: 800;
      font-size: 14px;
      line-height: 1.25;
    }

    .pub-card__title:hover {
      text-decoration: underline;
      text-decoration-color: rgba(47, 111, 237, 0.45);
    }

    .pub-card__badges {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .tag--soft {
      background: var(--soft);
    }

    .pub-card__tagline {
      margin: 8px 0 0;
      font-size: 13px;
      line-height: 1.5;
      color: #475569;
    }

    .pub-card__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
  </style>
</PageLayout>
